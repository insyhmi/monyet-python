<!--Use active-win system for tracking current tabs-->

<!DOCTYPE html>
<html>
  <head>
    <title>Procrastination Detector</title>
  </head>
  <body>
    <h1>Hello, Procrastinator!</h1>
    <p>Focus detected soon...</p>
    <p>Name your current task: </p>

    <div id="settings-display"></div>
    <br>

    <button id="start">Start Tracking</button>
    <button id="stop">Stop Tracking</button>
    <pre id="output"></pre>
    <pre id="procrastination-label"></pre>

    <script>

      let mainTask = null;
      let focusSettings = null;
      let whitelist = null;
      let isLoaded = false;

      // Get settings
      // TODO: only load other processes once settings are received
      async function displaySettings() {
        const settingsDiv = document.getElementById('settings-display');
        
        try {
          console.log("Calling getSetupData...");
          const data = await window.api.getSetupData();
          console.log("Setting data received:", data);
          
          if (data) {
            mainTask = data.activity;
            focusSettings = data.focusPeriod;
            whitelist = data.whitelist;

            settingsDiv.innerHTML = `
              <h3>Current Settings</h3>
              <p>Activity: ${mainTask}</p>
              <p>Focus: ${focusSettings.focus_length} mins</p>
              <p>Break: ${focusSettings.break_length} mins</p>
              <p>Whitelisted Sites: ${whitelist.join(', ')}</p>
            `;

            isLoaded = true;

          } else {
            settingsDiv.innerHTML = '<p>No settings saved yet</p>';
          }
        } catch (err) {
          settingsDiv.innerHTML = '<p>Error loading settings</p>';
          console.error(err);
        }
      }

      // Event listener
      window.addEventListener('DOMContentLoaded', displaySettings);

        const output = document.getElementById('output');
        const procrastinationLabel = document.getElementById('procrastination-label');
        const activityLog = {}; // Dictionary to store activity by app name
     
        document.getElementById('start').onclick = async () => {
          const taskInput = document.getElementById('task').value.trim();
          if (!taskInput) {
            alert("Please enter your current task before starting tracking.");
            return;
          }
          window.api.startTracking(taskInput);


        output.textContent = 'Started tracking...';
        };
        
        // Sends request to stop tracking
        document.getElementById('stop').onclick = () => {
          window.api.stopTracking();
          output.textContent = 'Stopped tracking.';
        };

        window.api.onWindowData(async (data) => {
          console.log((data));
          if (!data || !data.owner || !data.owner.name) return;

          const appName = activeWindow.owner.name;
          const timestamp = new Date().toLocaleString();

          // Array version
          if (!activityLog[appName]) {
              activityLog[appName] = [];
          }
          activityLog[appName].push({
            title: data.title || 'No title',
            url: data.url || 'N/A',
            time: timestamp
        });
        // Show latest app data
        const appData = {
          title: activeWindow.title || "No title",
          url: activeWindow.url || 'N/A',
        };

        output.textContent = JSON.stringify(appData, null, 2);
        // Procrastination analysis
        procrastinationLabel.textContent = analysis.isProcrastinating
          ? `Procrastinating (score: ${analysis.score.toFixed(2)})`
          : `Productive (score: ${analysis.score.toFixed(2)})`;
      });


    </script>
  </body>
</html>
