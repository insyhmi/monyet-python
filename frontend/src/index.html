<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Procrastination Tracker</title>
  <style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: 'Segoe UI', sans-serif;
        color: #333;
        font-size: 1.2rem;
        overflow: hidden;
        background: url('backgroundsecond.png') no-repeat center center fixed;
        background-size: cover;
    }


    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .main {
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 30px 40px;
    }

    .left-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: 10px;
    }

    .right-section {
        display: flex;
        flex-direction: column;
        justify-content: center; /* ⬅ Vertically centers contents */
        text-align: left;
        margin-right: ;
        padding-left: 40px;
        padding-right: 35px;
        min-width:300px;
        max-width: 400px;
        margin-top:53px;
        height: 100%;
    }



    #timer {
      font-size: 4rem;
      font-weight: bold;
  
    }

    .button-row {
      display: flex;
      gap: 16px;
      margin-bottom: 5px;
      margin-right: 10px;
    }

    button {
      padding: 12px 24px;
      font-size: 1.1rem;
      border: none;
      border-radius: 8px;
      background: #541ad1;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }

    button:hover {
      transform: scale(1.05);
    }

    .right-section {
      text-align: left;
      padding-left: 40px;
    }

    .right-section div {
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    .footer {
      text-align: center;
      padding: 12px 20px;
      font-size: 1.3rem;
      background: #949395;
      border-top: 1px solid #000000;
    }

    pre {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main">
      <div class="left-section">
        <div id="timer">00:00</div>
        <div class="button-row">
          <button id="start">Start</button>
          <button id="stop">Stop</button>
        </div>
        <button id="softstop">Debug Soft Stop</button>
      </div>
      <div class="right-section">
        <div id="activity-display">Current Activity: -</div>
        <div id="status-display">Status: -</div>
      </div>
    </div>
    <div class="footer">
      <div id="output">Current Window: -</div>
    </div>
  </div>

  <script>
    let mainTask = null;
    let focusSettings = null;
    let whitelist = null;
    let isLoaded = false;
    let focusTime, breakTime, focusIntervals;
    let timer;
    const activityLog = {};

    class FocusBreakTimer {
    constructor(focusTimeMinutes, breakTimeMinutes, intervals, display) {
        this.focusTime = focusTimeMinutes * 60;
        this.breakTime = breakTimeMinutes * 60;
        this.totalIntervals = intervals;
        this.display = display;
        this.currentInterval = 0;
        this.isFocus = true;
        this.timeLeft = this.focusTime;
        this.timer = null;
        this.running = false;
    }

    start() {
        if (this.currentInterval >= this.totalIntervals) {
        document.getElementById(this.display).textContent = "✅ Completed!";
        return;
        }

        if (this.running) return; // Prevent multiple intervals

        this.running = true;

        this.timer = setInterval(() => this.tick(), 1000);
    }

    tick() {
        const minutes = Math.floor(this.timeLeft / 60);
        const seconds = this.timeLeft % 60;
        document.getElementById(this.display).textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        this.timeLeft--;

        if (this.timeLeft < 0) {
        clearInterval(this.timer);
        this.running = false;

        if (!this.isFocus) this.currentInterval++;
        this.isFocus = !this.isFocus;

        if (this.currentInterval < this.totalIntervals) {
            this.timeLeft = this.isFocus ? this.focusTime : this.breakTime;
            this.start();
        } else {
            document.getElementById(this.display).textContent = "🎉 Finished!";
        }
        }
    }

    pause() {
        clearInterval(this.timer);
        this.running = false;
    }

    resetTimerText() {
        const minutes = Math.floor(this.timeLeft / 60);
        const seconds = this.timeLeft % 60;
        document.getElementById(this.display).textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    softStop() {
        this.currentInterval = this.totalIntervals;
        this.timeLeft = 1;
        this.sendScore();
    }

    hardStop() {
        clearInterval(this.timer);
        this.running = false;
        document.getElementById(this.display).textContent = "⏹️";
    }

    async sendScore() {
        try {
        const formattedData = Object.values(activityLog).flat().map(entry => ({
            procrastinating: entry.procrastinating,
            site: entry.site
        }));
        const response = await fetch("http://localhost:8000/score", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ data: formattedData })
        });
        const result = await response.json();
        document.getElementById("status-display").textContent += ` | Final Score: ${result.score}`;
        } catch (err) {
        console.error("Error sending score:", err);
        }
    }
    }


    async function displaySettings() {
      try {
        const data = await window.api.getSetupData();
        if (data) {
          mainTask = data.activity;
          focusSettings = data.focusPeriod;
          whitelist = data.whitelist;
          focusTime = focusSettings.focus_length;
          breakTime = focusSettings.break_length;
          focusIntervals = focusSettings.interval;

          document.getElementById("activity-display").textContent = mainTask;
          isLoaded = true;
          timer = new FocusBreakTimer(focusTime, breakTime, focusIntervals, "timer");
        } else {
          document.getElementById("activity-display").textContent = "No setup data.";
        }
      } catch (err) {
        console.error("Error loading setup data:", err);
      }
    }

    window.addEventListener("DOMContentLoaded", displaySettings);

    document.getElementById("start").onclick = () => {
      if (!isLoaded) return alert("Setup not loaded.");
      window.api.startTracking(mainTask);
      timer.start();
    };

    document.getElementById("stop").onclick = () => {
      window.api.stopTracking();
      timer.hardStop();
    };

    document.getElementById("softstop").onclick = () => {
      window.api.stopTracking();
      timer.softStop();
    };

    window.api.onWindowData((data) => {
      if (!data?.owner?.name) return;
      const appName = data.owner.name;
      const isProcrastinating = !whitelist.includes(appName);

      if (!activityLog[appName]) activityLog[appName] = [];
      activityLog[appName].push({ site: appName, procrastinating: isProcrastinating });

      document.getElementById("output").textContent = `Current Window: ${appName}`;
    });

    window.api.onBackendResult((analysis) => {
      const status = analysis.isProcrastinating
        ? `Procrastinating (score: ${analysis.score.toFixed(2)})`
        : `Productive (score: ${analysis.score.toFixed(2)})`;
      document.getElementById("status-display").textContent = status;
    });
  </script>
</body>
</html>
