<!--Use active-win system for tracking current tabs-->

<!DOCTYPE html>
<html>
  <head>
    <title>Procrastination Detector</title>
  </head>
  <body>
    <h1>Hello, Procrastinator!</h1>
    <p>Focus detected soon...</p>
    <p>Name your current task: </p>

    <div id="settings-display"></div>
    <br>

    <button id="start">Start Tracking</button>
    <button id="stop">Stop Tracking</button>
    <button id="softstop">Debug soft stop</button>
    <pre id="timer"></pre>
    <pre id="output"></pre>
    <pre id="procrastination-label"></pre>

    <pre id="session-conclusion"></div>
    
    <audio id="focus-audio" src="assets/test.mp3" preload="auto"></audio>
    <script>

        let mainTask = null;
        let focusSettings = null;
        let whitelist = null;
        let isLoaded = false;
        let focusTime;
        let breakTime;
        let focusIntervals;
        let wasProcrastinate = false;
        const focusAudio = document.getElementById('focus-audio');

        let score = null;
        let log_details = null;
        let recommendations = null;

        // Clock
        class FocusBreakTimer {
            constructor(focusTimeMinutes, breakTimeMinutes, intervals, display) {
                this.focusTime = focusTimeMinutes * 60; // convert to seconds
                this.breakTime = breakTimeMinutes * 60;
                this.totalIntervals = (intervals);
                this.display = display;
                this.currentInterval = 0;
                this.isFocus = true;
                this.timeLeft = this.focusTime;
                this.timer = null;
            }

            // Checks whether ticks have exceeded intervals
            start() {
                if (this.currentInterval >= this.totalIntervals) {
                    console.log("âœ… All intervals completed.");
                    document.getElementById(this.display).textContent = ("âœ… All intervals completed.");
                    return;
                }
                console.log(`ðŸ” Starting interval ${this.currentInterval + 1}/${this.totalIntervals}`);
                document.getElementById(this.display).textContent = (`ðŸ” Starting interval ${this.currentInterval + 1}/${this.totalIntervals}`);
                this.timeLeft = this.isFocus ? this.focusTime : this.breakTime;
                this.timer = setInterval(() => {
                this.tick();
                }, 1000);
            }

            // Ticks down and switches between corresponding phases when timer reaches zero
            tick() {
                const minutes = Math.floor(this.timeLeft / 60);
                const seconds = this.timeLeft % 60;
                const label = this.isFocus ? "ðŸ§  Focus Time" : "â˜• Break Time";
                console.log(`${label} : ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`);
                document.getElementById(this.display).textContent = `${label} Time: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                this.timeLeft--;
                if (this.timeLeft < 0) {
                    clearInterval(this.timer);
                    if (!this.isFocus) {
                        this.currentInterval++;
                    }
                    this.isFocus = !this.isFocus;
                    if (this.currentInterval < this.totalIntervals) {
                        this.start(); // start the next phase
                    } else {
                        console.log("ðŸŽ‰ All intervals complete!");
                        document.getElementById(this.display).textContent = "ðŸŽ‰ All intervals complete!";

                        // Sends score
                        this.sendScore();
                    }
                }
            }

            // Debug option to hasten the time to its end.
            softStop() {
                this.currentInterval = this.totalIntervals;
                this.timeLeft = 1;
                console.log("â¹ï¸ Soft Stop initiated.");
                this.sendScore();
            }
          
            hardStop() {
                clearInterval(this.timer);
                console.log("â¹ï¸ Timer stopped manually.");
                document.getElementById(this.display).textContent = "â¹ï¸ Timer stopped manually.";
            }
            
            // Gets score from backend
            async sendScore(){
                let result_data;
                try {
                    const formattedData = Object.values(activityLog).flat().map(entry => ({
                    procrastinating: entry.procrastinating,
                    site: entry.site
                }));

                    console.log("formattedData", formattedData);
                    const response = await fetch("http://localhost:8000/score", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ data: formattedData })
                    });
                    const result = await response.json();
                    result_data = {
                        "focus_length": focusTimeMinutes,
                        ...result.details
                    }
                    console.log("ðŸŽ¯ Score result:", result);
                    document.getElementById("procrastination-label").textContent += `\nFinal Score: ${result.score}`;

                } catch (err) {
                    console.error("Error sending score data:", err);
                }

                try {

                    console.log("Entering adapt:", result_data);
                    const adaptResponse = await fetch("http://localhost:8000/adapt", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ data: result_data.details })
                    });

                    const adaptResult = await adaptResponse.json();
                    const recommendations = adaptResult.recommendations || ["No recommendations for now!"];
                    const conclusionDiv = document.getElementById("session-conclusion");
                    print(recommendations);
                    conclusionDiv.innerHTML = "<strong>Recommendations:</strong><ul>" + 
                    recommendations.map(item => `<li>${item}</li>`).join("") +
                    "</ul>";

                } catch (err) {
                    console.error("Error getting recommendations:", err);
                }
        }
        // Get settings
        // TODO: only load other processes once settings are received
        async function displaySettings() {
            const settingsDiv = document.getElementById('settings-display');

            try {
                console.log("Calling getSetupData...");
                const data = await window.api.getSetupData();
                console.log("Setting data received:", data);
                
                // Gets data normally
                if (data) {
                    mainTask = data.activity;
                    focusSettings = data.focusPeriod;
                    whitelist = data.whitelist;
                    focusTime = focusSettings.focus_length;
                    breakTime = focusSettings.break_length;
                    focusIntervals = focusSettings.interval;
                    
                    settingsDiv.innerHTML = `
                        <h3>Current Settings</h3>
                        <p>Activity: ${mainTask}</p>
                        <p>Focus: ${focusTime} mins</p>
                        <p>Break: ${breakTime} mins</p>
                        <p>Whitelisted Sites: ${whitelist.join(', ')}</p>
                    `;

                    isLoaded = true;
                    timer = new FocusBreakTimer(focusTime, breakTime, focusIntervals, "timer");
                } else {
                    // Saves in settings-id
                    settingsDiv.innerHTML = '<p>No settings saved yet</p>';
                }}
            catch (err) {
                settingsDiv.innerHTML = '<p>Error loading settings</p>';
                console.error(err);
                }
        }
        
      // Event listener
        window.addEventListener('DOMContentLoaded', displaySettings);

        const output = document.getElementById('output');
        const procrastinationLabel = document.getElementById('procrastination-label');
        const activityLog = {}; // Dictionary to store activity by app name

        // Start tracking clicked
        document.getElementById('start').onclick = async () => {
            const taskInput = mainTask;
            if (!taskInput) {
                alert("Please enter your current task before starting tracking.");
                return;
            }
            window.api.startTracking(taskInput);
            timer.start();
            output.textContent = 'Started tracking...';
        };
        
        // Stop tracking clicked
        document.getElementById('stop').onclick = () => {
            window.api.stopTracking();
            output.textContent = 'Stopped tracking.';
            timer.hardStop();
        };

        document.getElementById('softstop').onclick = () => {
            window.api.stopTracking();
            timer.softStop();
        }
        
        async function gemini_changeApiInterval(time){ // time in miliseconds
            window.api.gemini_changeApiInterval(time);
            console.log("Gemini API interval changed. Now set to", time);
        }
        window.api.onWindowData(async (data) => {
            if (!data || !data.owner || !data.owner.name) return;

            const appName = data.owner.name;
            console.log(data.owner);
            if (!activityLog[appName]) {
                activityLog[appName] = [];
            }

            activityLog[appName].push({
                site: appName,
                procrastinating: procrastinating

            });

            output.textContent = JSON.stringify({ site: appName, procrastinating }, null, 2);
        });
        window.api.onBackendResult((analysis) => {
            console.log(analysis);
            if (analysis.isProcrastinating){
                if (!wasProcrastinate){
                    focusAudio.play().catch(err => {
                        console.error("Failed to load audio");
                    });
                }
            }else{
                wasProcrastinate = false;
            }
            procrastinationLabel.textContent = analysis.isProcrastinating
                ? `Procrastinating (score: ${analysis.score.toFixed(2)})`
                : `Productive (score: ${analysis.score.toFixed(2)})`;
        });
        
    </script>
  </body>
</html>
